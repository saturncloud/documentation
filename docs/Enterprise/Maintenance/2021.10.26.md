# Upgrading to Release 2021.10.26

## 1. Spin up an EC2 instance to run the installation

You will need to spin up an EC2 instance that you can SSH into. We recommend spinning up an EC2 instance
in the same subnet where your Saturn Cloud nodes run. If that is not possible (for example because you do not have
SSH access to private subnets) you can spin up the EC2 instance anywhere. Please use the Ubuntu 20.04 AMI and
attach the `customer-admin` role that you created for the initial Saturn Cloud installation to this EC2 instance.

## 2. Install Docker

```
sudo apt-get update

sudo apt-get install \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

 curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt-get update

sudo apt-get install docker-ce docker-ce-cli containerd.io
```

## 3. Upgrade Saturn Cloud

Set these environment variables:
```
export INSTALLER_TAG=2021.10.26-15
export DATA_DIR=/home/ubuntu/install
```

copy your `config.yaml` into `/home/ubuntu/install`

### 3a. Backup all EBS volumes

```
docker run --rm -it -v ${DATA_DIR}:/sdata ${AWS_AUTH_VARS} -e AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION} saturncloud/saturn-aws:${INSTALLER_TAG} python saturn_aws/scripts/main.py snapshots take
docker run --rm -it -v ${DATA_DIR}:/sdata ${AWS_AUTH_VARS} -e AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION} saturncloud/saturn-aws:${INSTALLER_TAG} python saturn_aws/scripts/main.py snapshots validate
```

### 3b. Run the upgrade

Run these commands:
```
docker run --rm -it -v ${DATA_DIR}:/sdata -e AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION} saturncloud/saturn-aws:${INSTALLER_TAG} python saturn_aws/scripts/main.py update-tf /sdata
docker run --rm -it -v ${DATA_DIR}:/sdata -e AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION} saturncloud/saturn-aws:${INSTALLER_TAG} python saturn_aws/scripts/main.py update-k8s /sdata
docker run --rm -it -v ${DATA_DIR}:/sdata -e AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION} saturncloud/saturn-aws:${INSTALLER_TAG} python saturn_aws/scripts/main.py migrate vpc-dns /sdata
```
